<script>
  // Only run on the cart page
  const currentUrl = window.location.href;
  if (currentUrl.includes("cart")) {
    // Get the cart data (assumes the cart object is output with a proper JSON structure)
    const cartData = {{ cart | json }};
    
    // Assuming the cart JSON includes an "items" array directly
    const cartItems = cartData.items.map(item => ({
      skuRefId: item.id,
      name: item.title,
      quantity: item.quantity,
      price: item.price
    }));
    
    // Get customer information (Liquid variables)
    const customer = {
      id: "{{ customer.id }}",
      name: "{{ customer.name }}",
      email: "{{ customer.email }}"
    };
    
    // Get store information. Make sure shop.id is available in your Liquid context.
    const store = {
      name: Shopify.shop,
      id: {{ shop.id }}
    };
    
    // Domain of your API endpoint
    const domain = "https://hygiene-retrieval-implications-retained.trycloudflare.com";
    const apiUrl = `${domain}/api/getRewardByOrder`;
    
    // Send the POST request with the cart, customer, and store info
    fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        data: {
          shop: store,
          items: cartItems,
          customer: customer
        }
      })
    })
      .then(res => res.json())
      .then(data => {
        console.log("Reward Response:", data);
        // You can handle the response further as needed
      })
      .catch(err => console.error("Error fetching rewards:", err));
  }
</script>

{% schema %}
{
  "name": "Loyalty Rewards",
  "target": "body"
}
{% endschema %}
